provider.on("chainChanged",e=>{location.reload()}),provider.on("accountsChanged",e=>{location.reload()});let networkName;function getNetworkName(e){switch(e){case 1:networkName="Mainnet";break;case 3:networkName="Ropsten";break;case 4:networkName="Rinkeby";break;case 42:networkName="Kovan";break;case 137:networkName="Poligyon Mainnet";break;case 80001:networkName="Mumbai";break;default:networkName="Unknown network"}return networkName}async function networkCheck(){flg=!0;let e=await web3.eth.net.getId();var t=getNetworkName(parseInt(current_network_id));if(getNetworkName(e),current_network_id!=e){for(;not_network_message.includes("[chainid]");)not_network_message=not_network_message.replace("[chainid]",t);alert(not_network_message),flg=!1}return flg}async function frontConnect(){if(void 0===window.ethereum){alert(not_installed_message);return}if(!contract_address){alert(not_blockchain_message);return}try{if(user=(accounts=await window.ethereum.request({method:"eth_requestAccounts"}))[0],inst=new web3.eth.Contract(abi,contract_address,{from:user}),!user){alert(could_not_connect_message);return}await ajaxSetUserData(await inst.methods.getOwnNFTList(creater_address).call());var e=document.getElementById("connect");e&&(e.innerText=connecting_message);var t=document.getElementById("my_page");t&&(t.style.display="block")}catch(a){viewErrorMessage(a)}}function ajaxSalesRegister(e,t,a,n){var r=new FormData;r.append("action","sales_register"),r.append("customer_address",n),r.append("token_id",e),r.append("quantity",t),r.append("sales",a),r.append("ajax_nonce",ajax_nonce),ajax_fetch(ajaxurl,r)}function ajaxSetUserData(e,t=null){var a=new FormData;a.append("action","set_user_data"),a.append("snpm_user_address",user);for(let n=0;n<e[0].length;n++)if(0!=e[1][n]){var r=Math.floor(Date.now()/1e3);0!=e[2][n]&&e[2][n]<r||a.append("owned_nfts[]",e[0][n])}a.append("ajax_nonce",ajax_nonce),ajax_fetch(ajaxurl,a,t)}async function ajaxChangeNetwork(e,t=null){current_network_id=e;var a=new FormData;a.append("action","change_network"),a.append("blockchain_network",e),a.append("ajax_nonce",ajax_nonce),await ajax_fetch(ajaxurl,a,t)}async function viewNftList(){if(user){var e=document.getElementById("owned-nft-list");if(e){spinner&&spinner.classList.add("active");try{for(var t=await inst.methods.getOwnNFTList(creater_address).call();e.lastChild;)e.removeChild(e.lastChild);if(t[0]){var a=await getNftListHtml(t);e.insertAdjacentHTML("beforeend",'<ul class="nft-list">'+a+"</ul>"),spinner&&spinner.classList.remove("active")}}catch(n){throw viewErrorMessage(n),spinner&&spinner.classList.remove("active"),n}}}}async function getNftListHtml(e){var t=new FormData;t.append("action","owned_nft_list");for(let a=0;a<e[0].length;a++)0!=e[1][a]&&(t.append("owned_nfts["+e[0][a]+"]",e[0][a]),t.append("owned["+e[0][a]+"]",e[1][a]),t.append("expiration["+e[0][a]+"]",e[2][a]));t.append("ajax_nonce",ajax_nonce);var n="";return await fetch(ajaxurl,{method:"POST",body:t}).then(function(e){return e.json()}).then(function(e){n=e.html}).catch(function(e){console.log(e)}),n}function templateNftList(e,t,a){return`<li>
  <div class="card">
  <div class="card-img"><img src="${e.image}" alt="${e.name}"></div>
  <div class="card-contents">
  <h3 class="card-title">${e.name}[${e.tokenId}]</h3>            
  <div class="card-description">${e.description}</div>
  <div class="card-expiration-date"><span class="card-label">${expiration_date_label}</span>${a=getExpirationDate(a)}</div>
  <div class="card-owned"><span class="card-label">${possessions_message}</span>${t}</div>
  </div>
  </div>
  </li>`}function getExpirationDate(e){var t=Math.floor(Date.now()/1e3);return e=0==e||9999999999999==e?indefinite_period:e<t?expired:getYmdHis(1e3*e)}async function buyToken(e){if(void 0===window.ethereum){alert(not_installed_message);return}user||await frontConnect();var t=e.target.dataset.tokenid,a=e.target.dataset.cost;if(0==e.target.dataset.expiration||!1!=window.confirm(expiration_notice)){var n=e.target.innerText;e.target.innerText=process_message,e.target.classList.add("inactive"),e.target.insertAdjacentHTML("afterbegin",'<i class="fa fa-circle-o-notch fa-spin fa-fw" id="circle-loading"></i>');var r=1*a;r=web3.utils.toWei(r.toString(),"ether");try{let i=await inst.methods.buyToken(creater_address,t,1).send({value:r});var s=i.events.BuyToken.returnValues,r=parseFloat(web3.utils.fromWei(s._cost,"ether")),c=getExpirationDate(s._expirationTimestamp);s._id&&ajaxSalesRegister(s._id,s._quantity,r,user),await ajaxSetUserData(await inst.methods.getOwnNFTList(creater_address).call()),alert(`
      ${purchase_completed_message}

      Token ID: ${s._id} 

      ${quantity_label}: ${s._quantity}

      ${price_label}: ${r.toFixed(7)} Matic

      ${expiration_date_label}: ${c} 
    `)}catch(o){throw viewErrorMessage(o),console.log(o),e.target.innerText=n,e.target.classList.remove("inactive"),o}finally{updateStock(t)}}}async function connect(){if(void 0===window.ethereum){alert(not_installed_message);return}if(!contract_address){alert(not_blockchain_message);return}if(!1!==await networkCheck())try{if(user=(accounts=await window.ethereum.request({method:"eth_requestAccounts"}))[0],inst=new web3.eth.Contract(abi,contract_address,{from:user}),creater_address&&parseInt(creater_address,16)!==parseInt(user,16)){alert(address_different_message+"\n"+change_address_message);return}connection_status()}catch(e){throw viewErrorMessage(e),e}}function connection_status(){var e=document.getElementById("connection_status");if(e){for(e.classList.remove("notice-warning"),e.classList.add("notice-success");e.lastChild;)e.removeChild(e.lastChild);e.insertAdjacentHTML("beforeend","<p>"+connecting_message+connected_address_message+"："+web3.currentProvider.selectedAddress+"</p>");var t=document.getElementById("connect");t&&(t.style.display="none")}}async function getBalance(e){if(!user){alert(connect_message);return}var t=document.getElementById("balance");if(t){if(e){var a=e.target.innerText;e.target.innerText=process_message,e.target.classList.add("inactive"),e.target.insertAdjacentHTML("afterbegin",'<i class="fa fa-circle-o-notch fa-spin fa-fw" id="circle-loading"></i>')}try{for(var n=await inst.methods.getBalance().call();t.lastChild;)t.removeChild(t.lastChild);t.insertAdjacentHTML("beforeend","<p>"+balance_message+"："+n/1e18+"Matic</p>"),e&&(e.target.innerText=a,e.target.classList.remove("inactive"))}catch(r){throw viewErrorMessage(r),e&&(e.target.innerText=a,e.target.classList.remove("inactive")),r}}}async function getUri(e){if(!user){alert(connect_message);return}var t=document.getElementById("current_base_metadata_uri");if(t)try{var a=await inst.methods.getURI().call();a?t.insertAdjacentHTML("beforeend",'<p class="alert alert-info">'+a+"</p>"):t.insertAdjacentHTML("beforeend",'<p class="alert alert-danger">'+current_metadata_message+"</p>")}catch(n){throw viewErrorMessage(n),n}}async function setUri(e){if(!user){alert(connect_message);return}var t=document.getElementById("base_metadata_uri").value;if(!t){alert(set_uri_message);return}var a=e.target.innerText;e.target.innerText=process_message,e.target.classList.add("inactive"),e.target.insertAdjacentHTML("afterbegin",'<i class="fa fa-circle-o-notch fa-spin fa-fw" id="circle-loading"></i>');try{var n=(await inst.methods.setURI(t).send()).events.SetURI.returnValues;alert(`
      Set URI successful!

      URI: ${n._uri}
    `),e&&(e.target.innerText=a,e.target.classList.remove("inactive")),location.reload()}catch(r){throw viewErrorMessage(r),e.target.innerText=a,e.target.classList.remove("inactive"),r}}async function updateStock(e){if(!user){alert(connect_message);return}try{var t=await inst.methods.balanceOfCreater(e,creater_address).call(),a=new FormData;a.append("action","update_stock"),a.append("token_id",e),a.append("token_stock",t),a.append("ajax_nonce",ajax_nonce),ajax_fetch(ajaxurl,a,completeUpdateStock)}catch(n){throw viewErrorMessage(n),n}}async function getTokenData(e){if(!user){alert(connect_message);return}try{var t=await inst.methods.getNFTList(creater_address).call();if(t)var a=await setTokenData(t);if(!t||!1===a){alert(not_exist_token_message);var n=document.getElementById("token_id");n&&(n.value="");return}}catch(r){throw viewErrorMessage(r),r}}async function setTokenData(e,t=null){var a=!1,n=document.getElementById("token_id").value;for(let r=0;r<e.length;r++)if(n==e[r].id){var i=document.getElementById("token_cost");if(i){var s=parseFloat(web3.utils.fromWei(e[r].cost,"ether"));i.value=s}var c=document.getElementById("token_issued");c&&(c.value=e[r].issued);var o=document.getElementById("token_expiration_date");o&&(o.value=e[r].expiration);var l=await inst.methods.balanceOfCreater(n,creater_address).call(),d=document.getElementById("token_stock");d&&(d.value=l),a=!0;break}return a}function completeUpdateStock(e,t){!0===e.flg&&location.reload()}async function withdraw(e){if(!user){alert(connect_message);return}try{if(await inst.methods.getBalance().call()<=0){alert(no_balance_message);return}var t=e.target.innerText;e.target.innerText=process_message,e.target.classList.add("inactive"),e.target.insertAdjacentHTML("afterbegin",'<i class="fa fa-circle-o-notch fa-spin fa-fw" id="circle-loading"></i>'),await inst.methods.withdraw().send({from:user}),alert(withdrawal_message),getBalance(),e&&(e.target.innerText=t,e.target.classList.remove("inactive"))}catch(a){throw viewErrorMessage(a),e&&(e.target.innerText=t,e.target.classList.remove("inactive")),a}}async function getNftBalance(){if(!user){alert(connect_message);return}var e=document.getElementById("token_stock");if(e){var t=document.getElementById("token_id").value;if(null!==t)try{var a=await inst.methods.balanceOfCreater(t).call();e.value=a}catch(n){throw viewErrorMessage(n),n}}}async function burn(e){if(!user){alert(connect_message);return}var t=document.getElementById("token_id").value,a=document.getElementById("token_stock").value,n=document.getElementById("token_burn_number").value;if(!n){alert(quantity_not_message);return}if(0>!n){alert(quantity_incorrect_message);return}if(parseInt(a)<parseInt(n)){alert(quantity_exceeds_message);return}var r=e.target.innerText;e.target.innerText=process_message,e.target.classList.add("inactive"),e.target.classList.remove("button-danger"),e.target.insertAdjacentHTML("afterbegin",'<i class="fa fa-circle-o-notch fa-spin fa-fw" id="circle-loading"></i>');try{var i=(await inst.methods.burn(t,n).send()).events.Burn.returnValues;alert(`
      Burn successful!

      Token ID: ${i._id} 

      ${quantity_label}: ${i._quantity}
    `),await updateStock(t),e&&(e.target.innerText=r,e.target.classList.remove("inactive"))}catch(s){throw viewErrorMessage(s),e.target.innerText=r,e.target.classList.remove("inactive"),e.target.classList.add("button-danger"),s}}async function transfer(e){if(!user){alert(connect_message);return}var t=document.getElementById("token_id").value,a=document.getElementById("token_stock").value,n=document.getElementById("token_transfer_number").value,r=document.getElementById("to_address").value,i=document.getElementById("token_expiration_date").value;if(!n){alert(quantity_not_message);return}if(0>!n){alert(quantity_incorrect_message);return}if(!r){alert(to_address_not_message);return}if(parseInt(a)<parseInt(n)){alert(quantity_exceeds_message);return}var s=e.target.innerText;e.target.innerText=process_message,e.target.classList.add("inactive"),e.target.insertAdjacentHTML("afterbegin",'<i class="fa fa-circle-o-notch fa-spin fa-fw" id="circle-loading"></i>');try{var c=(await inst.methods.transferFromCreater(creater_address,r,t,n,i).send()).events.TransferFrom.returnValues;alert(`
      Transfer successful!

      Token ID: ${c._id} 

      ${quantity_label}: ${c._quantity}

      To address: ${c._to}
    `),await updateStock(t),e&&(e.target.innerText=s,e.target.classList.remove("inactive"))}catch(o){throw viewErrorMessage(o),e.target.innerText=s,e.target.classList.remove("inactive"),o}}async function mint(e){if(void 0===window.ethereum){alert(not_installed_message);return}let t=document.getElementById("form-submit");if(t){var a=t.innerText;t.innerText=process_message,t.classList.add("inactive"),t.insertAdjacentHTML("afterbegin",'<i class="fa fa-circle-o-notch fa-spin fa-fw" id="circle-loading"></i>')}inst=new web3.eth.Contract(abi,contract_address,{from:creater_address});var n=e.token_issued,r=e.token_cost,i=e.token_expiration_date;r=web3.utils.toWei(r.toString(),"ether");try{let s=await inst.methods.mint(n,r,i).send();var c=s.events.Mint.returnValues;return parseFloat(web3.utils.fromWei(c._cost,"ether")),c._id}catch(o){throw viewErrorMessage(o),t.innerText=a,t.classList.remove("inactive"),o}}function viewErrorMessage(e){4001==e.code?alert(denied_transaction_message):"Transaction was not mined within 50 blocks, please make sure your transaction was properly sent. Be aware that it might still be mined!"==e.message?alert(transaction_pending_message):alert(e.message)}